# 数据库说明书

## 文档信息

| 项目名称 | VibeCoding高情商聊天助手 |
|---------|----------------------|
| 文档版本 | V1.0 |
| 编写日期 | 2026-02-18 |
| 文档类型 | 数据库说明书 |

## 目录

1. [数据库概述](#1-数据库概述)
2. [数据库表结构](#2-数据库表结构)
3. [表关系说明](#3-表关系说明)
4. [索引设计](#4-索引设计)
5. [数据字典](#5-数据字典)
6. [初始化数据](#6-初始化数据)
7. [维护说明](#7-维护说明)

---

## 1. 数据库概述

### 1.1 数据库选型

系统支持两种数据库：

| 数据库 | 版本 | 适用场景 | 说明 |
|--------|------|---------|------|
| SQLite | 3.x | 开发环境 | 轻量级，无需独立安装，文件存储 |
| MySQL | 5.7+ | 生产环境 | 高性能，支持高并发，功能完善 |

### 1.2 数据库配置

#### SQLite配置

- 数据库文件：`backend/vibe_chat.db`
- 连接字符串：`sqlite:///vibe_chat.db`

#### MySQL配置

在 `backend/.env` 文件中配置：

```
DATABASE_TYPE=mysql
DATABASE_HOST=localhost
DATABASE_PORT=3306
DATABASE_USER=root
DATABASE_PASSWORD=your_password
DATABASE_NAME=vibe_chat
```

### 1.3 字符集和排序规则

- 字符集：`utf8mb4`
- 排序规则：`utf8mb4_unicode_ci`

### 1.4 数据库特点

- 支持外键关联
- 支持索引优化
- 支持全文索引
- 支持事务处理
- 支持JSON数据类型

---

## 2. 数据库表结构

### 2.1 用户表 (users)

存储用户基本信息和偏好设置。

#### 表结构

| 字段名 | 类型 | 长度 | 允许NULL | 默认值 | 说明 |
|--------|------|------|---------|--------|------|
| id | BIGINT | - | 否 | AUTO_INCREMENT | 用户ID，主键 |
| username | VARCHAR | 50 | 否 | - | 用户名，唯一 |
| password_hash | VARCHAR | 255 | 否 | - | 密码哈希值（Bcrypt加密） |
| phone | VARCHAR | 20 | 是 | NULL | 手机号，唯一 |
| email | VARCHAR | 100 | 是 | NULL | 邮箱 |
| role | VARCHAR | 20 | 否 | 'user' | 用户角色 |
| avatar_url | VARCHAR | 255 | 是 | NULL | 头像URL |
| is_active | TINYINT | 1 | 否 | 1 | 是否激活（1=是，0=否） |
| is_vip | TINYINT | 1 | 否 | 0 | 是否VIP（1=是，0=否） |
| vip_expire_time | DATETIME | - | 是 | NULL | VIP过期时间 |
| tone_preference | VARCHAR | 20 | 否 | '温和' | 语气偏好 |
| length_preference | VARCHAR | 20 | 否 | '简洁版' | 长度偏好 |
| created_at | TIMESTAMP | - | 否 | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | - | 否 | CURRENT_TIMESTAMP | 更新时间 |

#### 索引

| 索引名 | 字段 | 类型 | 说明 |
|--------|------|------|------|
| PRIMARY | id | PRIMARY | 主键索引 |
| idx_username | username | UNIQUE | 用户名唯一索引 |
| idx_phone | phone | UNIQUE | 手机号唯一索引 |
| idx_role | role | INDEX | 角色索引 |

#### 业务规则

- 用户名必须唯一，长度3-50字符
- 手机号必须唯一，11位数字
- 密码使用Bcrypt算法加密存储
- 默认角色为普通用户
- 默认激活状态为激活

---

### 2.2 岗位表 (positions)

定义系统支持的岗位类型。

#### 表结构

| 字段名 | 类型 | 长度 | 允许NULL | 默认值 | 说明 |
|--------|------|------|---------|--------|------|
| id | INT | - | 否 | AUTO_INCREMENT | 岗位ID，主键 |
| name | VARCHAR | 50 | 否 | - | 岗位名称 |
| code | VARCHAR | 20 | 否 | - | 岗位代码，唯一 |
| description | VARCHAR | 200 | 是 | NULL | 岗位描述 |
| sort_order | INT | - | 否 | 0 | 排序序号 |
| is_active | TINYINT | 1 | 否 | 1 | 是否启用（1=是，0=否） |
| created_at | TIMESTAMP | - | 否 | CURRENT_TIMESTAMP | 创建时间 |

#### 索引

| 索引名 | 字段 | 类型 | 说明 |
|--------|------|------|------|
| PRIMARY | id | PRIMARY | 主键索引 |
| uk_code | code | UNIQUE | 岗位代码唯一索引 |

#### 业务规则

- 岗位代码必须唯一
- 默认启用状态为启用

#### 预设数据

| id | name | code | description | sort_order |
|-----|------|------|-------------|-----------|
| 1 | 售前人员 | pre_sales | 负责客户对接、需求咨询、方案讲解 | 1 |
| 2 | 项目经理 | project_manager | 负责项目统筹、进度管理、团队协调 | 2 |
| 3 | 产品经理 | product_manager | 负责需求沟通、产品规划、需求变更 | 3 |
| 4 | 前端开发 | frontend | 负责前端开发、技术对接、UI实现 | 4 |
| 5 | 后端开发 | backend | 负责后端开发、接口设计、数据库设计 | 5 |
| 6 | UI设计师 | ui_designer | 负责界面设计、交互设计、设计交付 | 6 |
| 7 | 测试工程师 | tester | 负责测试、bug反馈、质量保障 | 7 |

---

### 2.3 话术分类表 (script_categories)

定义话术的分类体系。

#### 表结构

| 字段名 | 类型 | 长度 | 允许NULL | 默认值 | 说明 |
|--------|------|------|---------|--------|------|
| id | INT | - | 否 | AUTO_INCREMENT | 分类ID，主键 |
| name | VARCHAR | 50 | 否 | - | 分类名称 |
| code | VARCHAR | 50 | 否 | - | 分类代码，唯一 |
| parent_id | INT | - | 否 | 0 | 父分类ID（0表示顶级分类） |
| position_id | INT | - | 是 | NULL | 关联岗位ID |
| description | VARCHAR | 200 | 是 | NULL | 分类描述 |
| icon | VARCHAR | 100 | 是 | NULL | 分类图标 |
| sort_order | INT | - | 否 | 0 | 排序序号 |
| is_active | TINYINT | 1 | 否 | 1 | 是否启用（1=是，0=否） |
| created_at | TIMESTAMP | - | 否 | CURRENT_TIMESTAMP | 创建时间 |

#### 索引

| 索引名 | 字段 | 类型 | 说明 |
|--------|------|------|------|
| PRIMARY | id | PRIMARY | 主键索引 |
| uk_code | code | UNIQUE | 分类代码唯一索引 |
| idx_position_id | position_id | INDEX | 岗位ID索引 |
| idx_parent_id | parent_id | INDEX | 父分类ID索引 |

#### 业务规则

- 分类代码必须唯一
- parent_id为0表示顶级分类
- position_id为NULL表示通用分类
- 支持二级分类结构

---

### 2.4 话术表 (scripts)

存储所有话术内容。

#### 表结构

| 字段名 | 类型 | 长度 | 允许NULL | 默认值 | 说明 |
|--------|------|------|---------|--------|------|
| id | BIGINT | - | 否 | AUTO_INCREMENT | 话术ID，主键 |
| title | VARCHAR | 100 | 否 | - | 话术标题 |
| content | TEXT | - | 否 | - | 话术完整内容 |
| brief_content | TEXT | - | 是 | NULL | 话术简洁版内容 |
| category_id | INT | - | 否 | - | 所属分类ID |
| position_id | INT | - | 是 | NULL | 关联岗位ID |
| scene_type | VARCHAR | 50 | 否 | - | 场景类型 |
| tone | VARCHAR | 20 | 否 | '温和' | 语气 |
| target_audience | VARCHAR | 50 | 是 | NULL | 目标对象 |
| tags | VARCHAR | 200 | 是 | NULL | 标签，逗号分隔 |
| usage_count | INT | - | 否 | 0 | 使用次数 |
| like_count | INT | - | 否 | 0 | 点赞次数 |
| is_free | TINYINT | 1 | 否 | 1 | 是否免费（1=是，0=否） |
| is_active | TINYINT | 1 | 否 | 1 | 是否启用（1=是，0=否） |
| created_by | BIGINT | - | 是 | NULL | 创建者ID |
| created_at | TIMESTAMP | - | 否 | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | - | 否 | CURRENT_TIMESTAMP | 更新时间 |

#### 索引

| 索引名 | 字段 | 类型 | 说明 |
|--------|------|------|------|
| PRIMARY | id | PRIMARY | 主键索引 |
| idx_category_id | category_id | INDEX | 分类ID索引 |
| idx_position_id | position_id | INDEX | 岗位ID索引 |
| idx_scene_type | scene_type | INDEX | 场景类型索引 |
| idx_tags | tags(100) | INDEX | 标签索引（前100字符） |
| idx_content | title, content | FULLTEXT | 全文索引 |

#### 业务规则

- title和content必填
- 默认语气为温和
- 每次查看话术时usage_count+1
- 用户点赞时like_count+1
- 支持全文搜索

#### 场景类型枚举

| 场景类型 | 说明 |
|---------|------|
| 需求沟通 | 需求调研、需求确认、需求变更等 |
| 项目推进 | 项目启动、任务分配、进度同步等 |
| Bug处理 | Bug反馈、Bug修复、Bug验证等 |
| 客户对接 | 客户接待、方案讲解、异议处理等 |
| 协同配合 | 请教问题、请求帮助、感谢帮忙等 |
| 会议沟通 | 会议开场、会议讨论、会议总结等 |

#### 语气枚举

| 语气 | 说明 |
|------|------|
| 温和 | 语气亲切，适合日常协作 |
| 专业 | 语言规范，适合正式沟通 |
| 委婉 | 表达含蓄，适合敏感话题 |
| 活泼 | 语言生动，适合轻松氛围 |

---

### 2.5 用户收藏表 (user_favorites)

记录用户的话术收藏。

#### 表结构

| 字段名 | 类型 | 长度 | 允许NULL | 默认值 | 说明 |
|--------|------|------|---------|--------|------|
| id | BIGINT | - | 否 | AUTO_INCREMENT | 收藏ID，主键 |
| user_id | BIGINT | - | 否 | - | 用户ID |
| script_id | BIGINT | - | 否 | - | 话术ID |
| custom_content | TEXT | - | 是 | NULL | 自定义话术内容 |
| created_at | TIMESTAMP | - | 否 | CURRENT_TIMESTAMP | 创建时间 |

#### 索引

| 索引名 | 字段 | 类型 | 说明 |
|--------|------|------|------|
| PRIMARY | id | PRIMARY | 主键索引 |
| uk_user_script | user_id, script_id | UNIQUE | 用户-话术唯一索引 |
| idx_user_id | user_id | INDEX | 用户ID索引 |
| idx_script_id | script_id | INDEX | 话术ID索引 |

#### 业务规则

- 同一用户对同一话术只能收藏一次
- 支持收藏时自定义修改内容

---

### 2.6 对话记录表 (conversations)

存储AI对话历史。

#### 表结构

| 字段名 | 类型 | 长度 | 允许NULL | 默认值 | 说明 |
|--------|------|------|---------|--------|------|
| id | BIGINT | - | 否 | AUTO_INCREMENT | 对话ID，主键 |
| user_id | BIGINT | - | 否 | - | 用户ID |
| session_id | VARCHAR | 64 | 否 | - | 会话ID |
| message_type | VARCHAR | 20 | 否 | - | 消息类型（user/assistant） |
| content | TEXT | - | 否 | - | 消息内容 |
| context_data | JSON | - | 是 | NULL | 上下文数据 |
| intent | VARCHAR | 50 | 是 | NULL | 识别的意图 |
| referenced_script_id | BIGINT | - | 是 | NULL | 关联的话术ID |
| created_at | TIMESTAMP | - | 否 | CURRENT_TIMESTAMP | 创建时间 |

#### 索引

| 索引名 | 字段 | 类型 | 说明 |
|--------|------|------|------|
| PRIMARY | id | PRIMARY | 主键索引 |
| idx_user_id | user_id | INDEX | 用户ID索引 |
| idx_session_id | session_id | INDEX | 会话ID索引 |
| idx_created_at | created_at | INDEX | 创建时间索引 |

#### 业务规则

- message_type为user表示用户消息
- message_type为assistant表示AI回复
- session_id用于关联同一会话的多条消息
- 所有对话自动保存

---

### 2.7 话术调整记录表 (script_adjustments)

记录话术调整历史。

#### 表结构

| 字段名 | 类型 | 长度 | 允许NULL | 默认值 | 说明 |
|--------|------|------|---------|--------|------|
| id | BIGINT | - | 否 | AUTO_INCREMENT | 调整ID，主键 |
| user_id | BIGINT | - | 否 | - | 用户ID |
| script_id | BIGINT | - | 否 | - | 话术ID |
| original_content | TEXT | - | 是 | NULL | 原始内容 |
| adjusted_content | TEXT | - | 是 | NULL | 调整后内容 |
| tone | VARCHAR | 20 | 是 | NULL | 调整的语气 |
| length_type | VARCHAR | 20 | 是 | NULL | 调整的长度类型 |
| feedback | VARCHAR | 200 | 是 | NULL | 用户反馈 |
| created_at | TIMESTAMP | - | 否 | CURRENT_TIMESTAMP | 创建时间 |

#### 索引

| 索引名 | 字段 | 类型 | 说明 |
|--------|------|------|------|
| PRIMARY | id | PRIMARY | 主键索引 |
| idx_user_id | user_id | INDEX | 用户ID索引 |
| idx_script_id | script_id | INDEX | 话术ID索引 |

#### 业务规则

- 记录每次话术调整操作
- 用于后续分析和优化

---

### 2.8 系统配置表 (system_configs)

存储系统配置参数。

#### 表结构

| 字段名 | 类型 | 长度 | 允许NULL | 默认值 | 说明 |
|--------|------|------|---------|--------|------|
| id | INT | - | 否 | AUTO_INCREMENT | 配置ID，主键 |
| config_key | VARCHAR | 100 | 否 | - | 配置键，唯一 |
| config_value | TEXT | - | 是 | NULL | 配置值 |
| description | VARCHAR | 200 | 是 | NULL | 配置描述 |
| created_at | TIMESTAMP | - | 否 | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | - | 否 | CURRENT_TIMESTAMP | 更新时间 |

#### 索引

| 索引名 | 字段 | 类型 | 说明 |
|--------|------|------|------|
| PRIMARY | id | PRIMARY | 主键索引 |
| uk_config_key | config_key | UNIQUE | 配置键唯一索引 |

#### 预设配置

| config_key | config_value | description |
|-----------|-------------|-------------|
| app_name | VibeCoding高情商聊天助手 | 应用名称 |
| default_tone | 温和 | 默认语气 |
| default_length | 简洁版 | 默认长度 |
| max_context_turns | 10 | 最大上下文轮次 |
| response_timeout | 2 | 响应超时时间(秒) |

---

## 3. 表关系说明

### 3.1 ER图

```
users (用户表)
    ├─1:N─→ user_favorites (用户收藏表)
    │          └─N:1─→ scripts (话术表)
    ├─1:N─→ conversations (对话记录表)
    └─1:N─→ script_adjustments (话术调整记录表)

positions (岗位表)
    └─1:N─→ script_categories (话术分类表)
           └─1:N─→ scripts (话术表)

script_categories (话术分类表)
    └─1:N─→ scripts (话术表)

scripts (话术表)
    ├─1:N─→ user_favorites (用户收藏表)
    └─1:N─→ script_adjustments (话术调整记录表)

system_configs (系统配置表) [独立表]
```

### 3.2 关系说明

#### users → user_favorites

- 关系类型：一对多
- 说明：一个用户可以有多个收藏
- 外键：user_id

#### users → conversations

- 关系类型：一对多
- 说明：一个用户可以有多个对话记录
- 外键：user_id

#### users → script_adjustments

- 关系类型：一对多
- 说明：一个用户可以有多个调整记录
- 外键：user_id

#### positions → script_categories

- 关系类型：一对多
- 说明：一个岗位可以有多个分类
- 外键：position_id

#### script_categories → scripts

- 关系类型：一对多
- 说明：一个分类可以有多个话术
- 外键：category_id

#### scripts → user_favorites

- 关系类型：一对多
- 说明：一个话术可以被多个用户收藏
- 外键：script_id

#### scripts → script_adjustments

- 关系类型：一对多
- 说明：一个话术可以有多个调整记录
- 外键：script_id

---

## 4. 索引设计

### 4.1 主键索引

所有表都使用自增ID作为主键，保证数据的唯一性和查询效率。

### 4.2 唯一索引

| 表名 | 索引名 | 字段 | 说明 |
|------|--------|------|------|
| users | idx_username | username | 用户名唯一 |
| users | idx_phone | phone | 手机号唯一 |
| positions | uk_code | code | 岗位代码唯一 |
| script_categories | uk_code | code | 分类代码唯一 |
| user_favorites | uk_user_script | user_id, script_id | 用户-话术唯一 |
| system_configs | uk_config_key | config_key | 配置键唯一 |

### 4.3 普通索引

| 表名 | 索引名 | 字段 | 说明 |
|------|--------|------|------|
| users | idx_role | role | 角色查询 |
| script_categories | idx_position_id | position_id | 岗位查询 |
| script_categories | idx_parent_id | parent_id | 父分类查询 |
| scripts | idx_category_id | category_id | 分类查询 |
| scripts | idx_position_id | position_id | 岗位查询 |
| scripts | idx_scene_type | scene_type | 场景查询 |
| scripts | idx_tags | tags(100) | 标签查询 |
| user_favorites | idx_user_id | user_id | 用户查询 |
| user_favorites | idx_script_id | script_id | 话术查询 |
| conversations | idx_user_id | user_id | 用户查询 |
| conversations | idx_session_id | session_id | 会话查询 |
| conversations | idx_created_at | created_at | 时间查询 |
| script_adjustments | idx_user_id | user_id | 用户查询 |
| script_adjustments | idx_script_id | script_id | 话术查询 |

### 4.4 全文索引

| 表名 | 索引名 | 字段 | 说明 |
|------|--------|------|------|
| scripts | idx_content | title, content | 全文搜索 |

---

## 5. 数据字典

### 5.1 枚举值

#### 用户角色 (role)

| 值 | 说明 |
|-----|------|
| user | 普通用户 |
| admin | 管理员 |

#### 话术语气 (tone)

| 值 | 说明 |
|-----|------|
| 温和 | 语气亲切，适合日常协作 |
| 专业 | 语言规范，适合正式沟通 |
| 委婉 | 表达含蓄，适合敏感话题 |
| 活泼 | 语言生动，适合轻松氛围 |

#### 话术长度 (length_preference)

| 值 | 说明 |
|-----|------|
| 简洁版 | 精简内容，直奔主题 |
| 标准版 | 保持原样 |
| 详细版 | 丰富细节，全面阐述 |

#### 场景类型 (scene_type)

| 值 | 说明 |
|-----|------|
| 需求沟通 | 需求调研、需求确认、需求变更等 |
| 项目推进 | 项目启动、任务分配、进度同步等 |
| Bug处理 | Bug反馈、Bug修复、Bug验证等 |
| 客户对接 | 客户接待、方案讲解、异议处理等 |
| 协同配合 | 请教问题、请求帮助、感谢帮忙等 |
| 会议沟通 | 会议开场、会议讨论、会议总结等 |

#### 消息类型 (message_type)

| 值 | 说明 |
|-----|------|
| user | 用户消息 |
| assistant | AI回复 |

#### 调整长度类型 (length_type)

| 值 | 说明 |
|-----|------|
| 简洁版 | 精简内容 |
| 标准版 | 保持原样 |
| 详细版 | 增加补充说明 |

---

## 6. 初始化数据

### 6.1 初始化脚本

初始化脚本位于 `database/init.sql`，包含：
- 创建数据库
- 创建所有表
- 插入初始数据（岗位、分类、话术、系统配置）

### 6.2 执行初始化

#### MySQL

```bash
mysql -u root -p < database/init.sql
```

#### SQLite

SQLite会自动创建数据库文件，无需手动执行初始化。

---

## 7. 维护说明

### 7.1 数据备份

#### MySQL备份

```bash
# 备份
mysqldump -u root -p vibe_chat > vibe_chat_backup.sql

# 恢复
mysql -u root -p vibe_chat < vibe_chat_backup.sql
```

#### SQLite备份

```bash
# 直接复制数据库文件
cp vibe_chat.db vibe_chat_backup.db
```

### 7.2 性能优化

#### 定期分析表

```sql
ANALYZE TABLE users;
ANALYZE TABLE scripts;
ANALYZE TABLE conversations;
```

#### 优化表

```sql
OPTIMIZE TABLE scripts;
OPTIMIZE TABLE conversations;
```

### 7.3 数据清理

#### 清理过期对话记录

```sql
DELETE FROM conversations WHERE created_at < DATE_SUB(NOW(), INTERVAL 90 DAY);
```

#### 清理过期调整记录

```sql
DELETE FROM script_adjustments WHERE created_at < DATE_SUB(NOW(), INTERVAL 180 DAY);
```

### 7.4 监控建议

- 监控数据库连接数
- 监控慢查询
- 监控表大小
- 定期检查索引使用情况

---

**文档结束**
