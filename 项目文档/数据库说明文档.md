# 数据库说明文档

## 文档信息

| 项目名称 | VibeCoding高情商聊天助手 |
|---------|----------------------|
| 文档版本 | V1.0 |
| 编写日期 | 2026-02-18 |
| 文档类型 | 数据库说明文档 |

## 目录

1. [数据库简介](#1-数据库简介)
2. [表结构详解](#2-表结构详解)
3. [SQL操作示例](#3-sql操作示例)
4. [性能优化](#4-性能优化)
5. [故障排查](#5-故障排查)

---

## 1. 数据库简介

### 1.1 数据库概述

本系统使用关系型数据库存储数据，支持SQLite和MySQL两种数据库：

- **SQLite**：开发环境使用，轻量级、无需独立安装
- **MySQL**：生产环境使用，高性能、支持高并发

### 1.2 数据库特点

- 支持事务处理
- 支持外键关联
- 支持索引优化
- 支持全文搜索
- 支持JSON数据类型

### 1.3 连接配置

#### SQLite连接

```python
# 连接字符串
sqlite:///vibe_chat.db
```

#### MySQL连接

```python
# 连接字符串
mysql+pymysql://username:password@host:port/database?charset=utf8mb4
```

---

## 2. 表结构详解

### 2.1 用户表 (users)

#### 表用途

存储用户基本信息、认证信息和偏好设置。

#### 核心字段说明

| 字段 | 说明 | 业务规则 |
|------|------|---------|
| id | 用户唯一标识 | 自增主键 |
| username | 用户名 | 唯一，3-50字符 |
| password_hash | 密码哈希 | Bcrypt加密，不可逆 |
| phone | 手机号 | 唯一，11位数字 |
| role | 用户角色 | user/admin |
| tone_preference | 默认语气 | 温和/专业/委婉/活泼 |
| length_preference | 默认长度 | 简洁版/标准版/详细版 |

#### 常用查询示例

```sql
-- 根据用户名查询用户
SELECT * FROM users WHERE username = 'testuser';

-- 查询所有激活的用户
SELECT * FROM users WHERE is_active = 1;

-- 按岗位统计用户数量
SELECT role, COUNT(*) as count FROM users GROUP BY role;
```

---

### 2.2 岗位表 (positions)

#### 表用途

定义系统支持的岗位类型，每个岗位对应一类话术库。

#### 核心字段说明

| 字段 | 说明 | 业务规则 |
|------|------|---------|
| id | 岗位唯一标识 | 自增主键 |
| code | 岗位代码 | 唯一，英文标识 |
| name | 岗位名称 | 中文显示名称 |
| sort_order | 排序 | 数字越小越靠前 |

#### 预设岗位

| id | code | name | description |
|-----|------|------|-------------|
| 1 | pre_sales | 售前人员 | 负责客户对接、需求咨询、方案讲解 |
| 2 | project_manager | 项目经理 | 负责项目统筹、进度管理、团队协调 |
| 3 | product_manager | 产品经理 | 负责需求沟通、产品规划、需求变更 |
| 4 | frontend | 前端开发 | 负责前端开发、技术对接、UI实现 |
| 5 | backend | 后端开发 | 负责后端开发、接口设计、数据库设计 |
| 6 | ui_designer | UI设计师 | 负责界面设计、交互设计、设计交付 |
| 7 | tester | 测试工程师 | 负责测试、bug反馈、质量保障 |

---

### 2.3 话术分类表 (script_categories)

#### 表用途

定义话术的分类体系，支持二级分类。

#### 核心字段说明

| 字段 | 说明 | 业务规则 |
|------|------|---------|
| id | 分类唯一标识 | 自增主键 |
| parent_id | 父分类ID | 0表示顶级分类 |
| position_id | 关联岗位ID | NULL表示通用分类 |
| code | 分类代码 | 唯一 |

#### 分类结构示例

```
顶级分类 (parent_id=0)
├─ 客户对接 (position_id=1)
│  ├─ 需求咨询
│  ├─ 方案讲解
│  ├─ 异议处理
│  └─ 合同洽谈
├─ 项目统筹 (position_id=2)
│  ├─ 任务分配
│  ├─ 进度同步
│  └─ 风险同步
└─ 日常协作 (position_id=NULL)
   ├─ 请教问题
   ├─ 感谢帮忙
   └─ 拒绝请求
```

---

### 2.4 话术表 (scripts)

#### 表用途

存储所有话术内容，是系统的核心数据表。

#### 核心字段说明

| 字段 | 说明 | 业务规则 |
|------|------|---------|
| id | 话术唯一标识 | 自增主键 |
| title | 话术标题 | 简洁明了，便于搜索 |
| content | 完整话术内容 | 详细的话术文本 |
| brief_content | 简洁版内容 | 精简版本，可选 |
| category_id | 所属分类ID | 关联script_categories表 |
| position_id | 关联岗位ID | 可为NULL表示通用 |
| scene_type | 场景类型 | 需求沟通/项目推进等 |
| tone | 语气 | 温和/专业/委婉/活泼 |
| tags | 标签 | 逗号分隔，便于搜索 |
| usage_count | 使用次数 | 每次查看+1 |
| like_count | 点赞次数 | 每次点赞+1 |
| is_free | 是否免费 | 1=免费，0=付费 |

#### 搜索功能实现

```sql
-- 关键词搜索（全文索引）
SELECT * FROM scripts
WHERE MATCH(title, content) AGAINST('需求 确认' IN NATURAL LANGUAGE MODE);

-- 多条件筛选
SELECT * FROM scripts
WHERE position_id = 3
  AND scene_type = '需求沟通'
  AND tone = '温和'
  AND is_active = 1
ORDER BY usage_count DESC
LIMIT 10;

-- 标签搜索
SELECT * FROM scripts
WHERE tags LIKE '%需求确认%'
  OR tags LIKE '%需求沟通%';
```

---

### 2.5 用户收藏表 (user_favorites)

#### 表用途

记录用户收藏的话术，支持自定义修改。

#### 核心字段说明

| 字段 | 说明 | 业务规则 |
|------|------|---------|
| user_id | 用户ID | 关联users表 |
| script_id | 话术ID | 关联scripts表 |
| custom_content | 自定义内容 | 用户修改的话术内容 |

#### 唯一约束

(user_id, script_id) 组合唯一，防止重复收藏。

#### 常用查询

```sql
-- 查询某用户的所有收藏
SELECT uf.*, s.title, s.content
FROM user_favorites uf
JOIN scripts s ON uf.script_id = s.id
WHERE uf.user_id = 123
ORDER BY uf.created_at DESC;

-- 检查是否已收藏
SELECT COUNT(*) as is_favorited
FROM user_favorites
WHERE user_id = 123 AND script_id = 456;
```

---

### 2.6 对话记录表 (conversations)

#### 表用途

存储AI对话历史，用于上下文管理和历史查询。

#### 核心字段说明

| 字段 | 说明 | 业务规则 |
|------|------|---------|
| user_id | 用户ID | 关联users表 |
| session_id | 会话ID | UUID格式，关联同一会话 |
| message_type | 消息类型 | user/assistant |
| content | 消息内容 | 文本内容 |
| intent | 识别的意图 | search/greeting/thank等 |
| context_data | 上下文数据 | JSON格式，存储额外信息 |

#### 对话查询

```sql
-- 查询某会话的所有消息
SELECT * FROM conversations
WHERE user_id = 123 AND session_id = 'uuid-string'
ORDER BY created_at ASC;

-- 查询最近的N条对话历史
SELECT * FROM conversations
WHERE user_id = 123
ORDER BY created_at DESC
LIMIT 10;

-- 统计用户对话次数
SELECT COUNT(*) as total_conversations
FROM conversations
WHERE user_id = 123 AND message_type = 'user';
```

---

### 2.7 话术调整记录表 (script_adjustments)

#### 表用途

记录话术调整历史，用于分析和优化。

#### 核心字段说明

| 字段 | 说明 | 业务规则 |
|------|------|---------|
| user_id | 用户ID | 关联users表 |
| script_id | 话术ID | 关联scripts表 |
| original_content | 原始内容 | 调整前的话术 |
| adjusted_content | 调整后内容 | 调整后的话术 |
| tone | 调整的语气 | 温和/专业/委婉/活泼 |
| length_type | 调整的长度 | 简洁版/标准版/详细版 |

#### 统计分析

```sql
-- 统计最常调整的语气
SELECT tone, COUNT(*) as count
FROM script_adjustments
GROUP BY tone
ORDER BY count DESC;

-- 统计最常被调整的话术
SELECT script_id, s.title, COUNT(*) as adjustment_count
FROM script_adjustments sa
JOIN scripts s ON sa.script_id = s.id
GROUP BY script_id, s.title
ORDER BY adjustment_count DESC;
```

---

### 2.8 系统配置表 (system_configs)

#### 表用途

存储系统运行参数，支持动态配置。

#### 核心字段说明

| 字段 | 说明 |
|------|------|
| config_key | 配置键，唯一 |
| config_value | 配置值，TEXT类型支持复杂值 |
| description | 配置说明 |

#### 常用配置

| config_key | config_value | 说明 |
|-----------|-------------|------|
| app_name | VibeCoding高情商聊天助手 | 应用名称 |
| default_tone | 温和 | 默认语气 |
| default_length | 简洁版 | 默认长度 |
| max_context_turns | 10 | 最大上下文轮次 |
| response_timeout | 2 | 响应超时时间(秒) |

---

## 3. SQL操作示例

### 3.1 用户相关操作

#### 创建用户

```sql
INSERT INTO users (username, password_hash, phone, email, role, tone_preference, length_preference)
VALUES ('testuser', '$2b$12$hash...', '13800138000', 'test@example.com', 'user', '温和', '简洁版');
```

#### 更新用户信息

```sql
UPDATE users
SET phone = '13900139000', email = 'new@example.com'
WHERE id = 1;
```

#### 删除用户（软删除）

```sql
UPDATE users
SET is_active = 0
WHERE id = 1;
```

---

### 3.2 话术相关操作

#### 创建话术

```sql
INSERT INTO scripts (title, content, brief_content, category_id, position_id, scene_type, tone, tags)
VALUES ('需求确认话术', '您好，关于[需求名称]，我想确认一下...', '关于[需求]需要确认...', 12, 3, '需求沟通', '温和', '需求确认,需求沟通');
```

#### 更新话术

```sql
UPDATE scripts
SET usage_count = usage_count + 1
WHERE id = 123;

UPDATE scripts
SET like_count = like_count + 1
WHERE id = 123;
```

#### 搜索话术

```sql
-- 基础搜索
SELECT * FROM scripts
WHERE is_active = 1
  AND (title LIKE '%需求%' OR content LIKE '%需求%' OR tags LIKE '%需求%')
ORDER BY usage_count DESC
LIMIT 10;

-- 复杂搜索
SELECT s.*, c.name as category_name, p.name as position_name
FROM scripts s
LEFT JOIN script_categories c ON s.category_id = c.id
LEFT JOIN positions p ON s.position_id = p.id
WHERE s.is_active = 1
  AND s.scene_type = '需求沟通'
  AND s.tone = '温和'
ORDER BY s.usage_count DESC;
```

---

### 3.3 收藏相关操作

#### 添加收藏

```sql
INSERT INTO user_favorites (user_id, script_id, custom_content)
VALUES (1, 123, '修改后的内容...');
```

#### 取消收藏

```sql
DELETE FROM user_favorites
WHERE user_id = 1 AND script_id = 123;
```

#### 查询收藏

```sql
SELECT uf.id, uf.custom_content, uf.created_at, s.title, s.content
FROM user_favorites uf
JOIN scripts s ON uf.script_id = s.id
WHERE uf.user_id = 1
ORDER BY uf.created_at DESC;
```

---

### 3.4 对话记录操作

#### 保存对话

```sql
INSERT INTO conversations (user_id, session_id, message_type, content, intent, referenced_script_id)
VALUES (1, 'uuid-string', 'user', '我需要需求沟通的话术', 'search', NULL);

INSERT INTO conversations (user_id, session_id, message_type, content, intent)
VALUES (1, 'uuid-string', 'assistant', '为您找到以下话术...', 'search');
```

#### 查询对话历史

```sql
SELECT * FROM conversations
WHERE user_id = 1 AND session_id = 'uuid-string'
ORDER BY created_at ASC;
```

---

### 3.5 统计查询

#### 用户统计

```sql
-- 总用户数
SELECT COUNT(*) as total_users FROM users;

-- 按岗位统计
SELECT role, COUNT(*) as count
FROM users
GROUP BY role;

-- 活跃用户（最近7天有对话）
SELECT DISTINCT u.id, u.username
FROM users u
JOIN conversations c ON u.id = c.user_id
WHERE c.created_at >= DATE_SUB(NOW(), INTERVAL 7 DAY);
```

#### 话术统计

```sql
-- 总话术数
SELECT COUNT(*) as total_scripts FROM scripts WHERE is_active = 1;

-- 按场景统计
SELECT scene_type, COUNT(*) as count
FROM scripts
WHERE is_active = 1
GROUP BY scene_type;

-- 按语气统计
SELECT tone, COUNT(*) as count
FROM scripts
WHERE is_active = 1
GROUP BY tone;

-- 最热门话术（按使用次数）
SELECT id, title, usage_count, like_count
FROM scripts
WHERE is_active = 1
ORDER BY usage_count DESC
LIMIT 10;
```

---

## 4. 性能优化

### 4.1 索引优化

#### 检查索引使用情况

```sql
-- MySQL
SHOW INDEX FROM scripts;

-- 查看索引使用统计
SELECT * FROM sys.schema_index_statistics;
```

#### 添加索引

```sql
-- 为常用查询添加索引
CREATE INDEX idx_scripts_position_scene ON scripts(position_id, scene_type);
CREATE INDEX idx_conversations_user_session ON conversations(user_id, session_id);
```

#### 删除无用索引

```sql
DROP INDEX idx_unused_index ON scripts;
```

---

### 4.2 查询优化

#### 避免全表扫描

```sql
-- 不好的查询（全表扫描）
SELECT * FROM scripts WHERE content LIKE '%关键词%';

-- 好的查询（使用全文索引）
SELECT * FROM scripts
WHERE MATCH(title, content) AGAINST('关键词' IN NATURAL LANGUAGE MODE);
```

#### 使用分页

```sql
-- 不好的查询（可能返回大量数据）
SELECT * FROM scripts;

-- 好的查询（分页）
SELECT * FROM scripts
ORDER BY usage_count DESC
LIMIT 10 OFFSET 0;
```

#### 避免SELECT *

```sql
-- 不好的查询
SELECT * FROM users WHERE id = 1;

-- 好的查询（只查询需要的字段）
SELECT id, username, role FROM users WHERE id = 1;
```

---

### 4.3 表维护

#### 分析表

```sql
ANALYZE TABLE scripts;
ANALYZE TABLE conversations;
```

#### 优化表

```sql
OPTIMIZE TABLE scripts;
OPTIMIZE TABLE conversations;
```

#### 清理数据

```sql
-- 清理90天前的对话记录
DELETE FROM conversations WHERE created_at < DATE_SUB(NOW(), INTERVAL 90 DAY);

-- 清理180天前的调整记录
DELETE FROM script_adjustments WHERE created_at < DATE_SUB(NOW(), INTERVAL 180 DAY);
```

---

## 5. 故障排查

### 5.1 连接问题

#### 问题：无法连接数据库

**排查步骤**：

1. 检查数据库服务是否启动
   ```bash
   # MySQL
   systemctl status mysql
   # Windows
   net start mysql
   ```

2. 检查连接配置
   - 验证主机地址、端口、用户名、密码
   - 检查防火墙设置

3. 检查数据库是否存在
   ```sql
   SHOW DATABASES;
   ```

4. 检查用户权限
   ```sql
   SHOW GRANTS FOR 'username'@'host';
   ```

---

### 5.2 查询慢

#### 问题：查询响应时间过长

**排查步骤**：

1. 开启慢查询日志
   ```sql
   SET GLOBAL slow_query_log = 'ON';
   SET GLOBAL long_query_time = 1;
   ```

2. 使用EXPLAIN分析查询
   ```sql
   EXPLAIN SELECT * FROM scripts WHERE title LIKE '%需求%';
   ```

3. 检查索引使用
   ```sql
   SHOW INDEX FROM scripts;
   ```

4. 优化查询语句或添加索引

---

### 5.3 锁问题

#### 问题：数据库表被锁定

**排查步骤**：

1. 查看当前锁
   ```sql
   SHOW OPEN TABLES WHERE In_use > 0;
   ```

2. 查看正在执行的进程
   ```sql
   SHOW PROCESSLIST;
   ```

3. 终止长时间运行的查询
   ```sql
   KILL process_id;
   ```

---

### 5.4 磁盘空间

#### 问题：数据库文件过大

**解决方案**：

1. 清理历史数据
   ```sql
   DELETE FROM conversations WHERE created_at < DATE_SUB(NOW(), INTERVAL 90 DAY);
   ```

2. 优化表
   ```sql
   OPTIMIZE TABLE conversations;
   ```

3. 定期备份数据后删除旧备份

---

### 5.5 数据一致性问题

#### 问题：外键约束失败

**排查步骤**：

1. 检查关联数据是否存在
   ```sql
   SELECT * FROM scripts WHERE category_id = 999;
   SELECT * FROM script_categories WHERE id = 999;
   ```

2. 检查数据完整性
   ```sql
   -- 找出无效的分类引用
   SELECT s.id, s.title
   FROM scripts s
   LEFT JOIN script_categories c ON s.category_id = c.id
   WHERE c.id IS NULL;
   ```

3. 修复数据或添加缺失的记录

---

## 6. 最佳实践

### 6.1 数据备份

- 定期备份数据库（建议每天）
- 保留最近7天的备份
- 备份文件异地存储

### 6.2 监控

- 监控数据库连接数
- 监控慢查询
- 监控磁盘使用率
- 设置告警阈值

### 6.3 安全

- 定期更新数据库版本
- 使用强密码
- 限制远程访问
- 定期审计用户权限

### 6.4 性能

- 定期分析表
- 定期优化表
- 清理历史数据
- 监控索引使用情况

---

**文档结束**
