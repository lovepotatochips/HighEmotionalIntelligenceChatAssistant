# 后端接口说明书

## 文档信息

| 项目名称 | VibeCoding高情商聊天助手 |
|---------|----------------------|
| 文档版本 | V1.0 |
| 编写日期 | 2026-02-18 |
| 文档类型 | 后端接口说明书 |

## 目录

1. [接口概述](#1-接口概述)
2. [认证接口](#2-认证接口)
3. [聊天接口](#3-聊天接口)
4. [话术接口](#4-话术接口)
5. [系统接口](#5-系统接口)
6. [错误码说明](#6-错误码说明)
7. [接口示例](#7-接口示例)

---

## 1. 接口概述

### 1.1 接口规范

- **协议**：HTTP/HTTPS
- **数据格式**：JSON
- **字符编码**：UTF-8
- **设计风格**：RESTful API

### 1.2 基础URL

- 开发环境：`http://localhost:8000`
- 生产环境：根据实际部署地址

### 1.3 认证方式

使用JWT（JSON Web Token）进行身份认证。

**请求头**：
```
Authorization: Bearer <token>
```

**获取令牌**：通过登录接口获取

### 1.4 统一响应格式

#### 成功响应

```json
{
  "code": 200,
  "message": "success",
  "data": {}
}
```

#### 错误响应

```json
{
  "code": 400,
  "message": "错误描述",
  "detail": "详细错误信息"
}
```

### 1.5 HTTP状态码

| 状态码 | 说明 |
|--------|------|
| 200 | 请求成功 |
| 201 | 创建成功 |
| 204 | 删除成功（无内容返回） |
| 400 | 请求参数错误 |
| 401 | 未认证或认证失败 |
| 404 | 资源不存在 |
| 500 | 服务器内部错误 |

---

## 2. 认证接口

### 2.1 用户注册

**接口地址**：`POST /api/auth/register`

**请求参数**：

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| username | string | 是 | 用户名，3-50字符 |
| password | string | 是 | 密码 |
| phone | string | 否 | 手机号，11位数字 |
| email | string | 否 | 邮箱 |
| role | string | 否 | 角色，默认'user' |
| avatar_url | string | 否 | 头像URL |
| tone_preference | string | 否 | 语气偏好，默认'温和' |
| length_preference | string | 否 | 长度偏好，默认'简洁版' |

**请求示例**：

```json
{
  "username": "testuser",
  "password": "password123",
  "phone": "13800138000",
  "email": "test@example.com",
  "role": "user",
  "tone_preference": "温和",
  "length_preference": "简洁版"
}
```

**响应示例**：

```json
{
  "id": 1,
  "username": "testuser",
  "phone": "13800138000",
  "email": "test@example.com",
  "role": "user",
  "avatar_url": null,
  "tone_preference": "温和",
  "length_preference": "简洁版",
  "is_active": true,
  "is_vip": false,
  "vip_expire_time": null,
  "created_at": "2026-02-18T10:00:00"
}
```

**错误码**：
- 400：用户名已存在、手机号已被注册、参数验证失败

---

### 2.2 用户登录

**接口地址**：`POST /api/auth/login`

**请求参数**（表单格式）：

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| username | string | 是 | 用户名 |
| password | string | 是 | 密码 |

**请求示例**：

```http
POST /api/auth/login
Content-Type: application/x-www-form-urlencoded

username=testuser&password=password123
```

**响应示例**：

```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "bearer",
  "user": {
    "id": 1,
    "username": "testuser",
    "role": "user",
    "tone_preference": "温和",
    "length_preference": "简洁版",
    "is_active": true
  }
}
```

**错误码**：
- 400：用户名或密码错误、用户已被禁用

---

### 2.3 获取当前用户信息

**接口地址**：`GET /api/auth/me`

**请求头**：
```
Authorization: Bearer <token>
```

**响应示例**：

```json
{
  "id": 1,
  "username": "testuser",
  "phone": "13800138000",
  "email": "test@example.com",
  "role": "user",
  "avatar_url": null,
  "tone_preference": "温和",
  "length_preference": "简洁版",
  "is_active": true,
  "is_vip": false,
  "vip_expire_time": null,
  "created_at": "2026-02-18T10:00:00"
}
```

**错误码**：
- 401：未认证或令牌无效

---

### 2.4 更新当前用户信息

**接口地址**：`PUT /api/auth/me`

**请求头**：
```
Authorization: Bearer <token>
```

**请求参数**：

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| phone | string | 否 | 手机号 |
| email | string | 否 | 邮箱 |
| role | string | 否 | 角色 |
| avatar_url | string | 否 | 头像URL |
| tone_preference | string | 否 | 语气偏好 |
| length_preference | string | 否 | 长度偏好 |

**请求示例**：

```json
{
  "phone": "13900139000",
  "email": "new@example.com",
  "tone_preference": "专业"
}
```

**响应示例**：

```json
{
  "id": 1,
  "username": "testuser",
  "phone": "13900139000",
  "email": "new@example.com",
  "role": "user",
  "tone_preference": "专业",
  "length_preference": "简洁版",
  "is_active": true
}
```

**错误码**：
- 401：未认证或令牌无效

---

## 3. 聊天接口

### 3.1 发送消息获取AI回复

**接口地址**：`POST /api/chat/message`

**请求头**：
```
Authorization: Bearer <token>
```

**请求参数**：

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| message | string | 是 | 消息内容 |
| session_id | string | 否 | 会话ID，首次对话可省略 |
| position | string | 否 | 岗位 |
| tone | string | 否 | 语气 |
| length | string | 否 | 长度 |

**请求示例**：

```json
{
  "message": "我需要向产品经理反馈一个需求不合理的问题",
  "position": "后端开发",
  "tone": "温和",
  "length": "简洁版"
}
```

**响应示例**：

```json
{
  "reply": "为您找到了3条需求沟通相关的话术：\n\n针对【后端开发】岗位：",
  "scripts": [
    {
      "id": 123,
      "title": "需求可行性沟通",
      "content": "关于[需求名称]，从技术实现角度来看...",
      "brief_content": "关于[需求]，从技术角度看有挑战...",
      "category_id": 12,
      "position_id": 5,
      "scene_type": "需求沟通",
      "tone": "温和",
      "target_audience": "同事",
      "tags": "需求,可行性,技术",
      "usage_count": 45,
      "like_count": 12,
      "is_free": true,
      "created_at": "2026-02-18T10:00:00"
    }
  ],
  "session_id": "uuid-string",
  "intent": "search"
}
```

**错误码**：
- 401：未认证或令牌无效

---

### 3.2 调整话术

**接口地址**：`POST /api/chat/adjust`

**请求参数**：

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| script_id | integer | 是 | 话术ID |
| tone | string | 否 | 目标语气 |
| length_type | string | 否 | 长度类型 |

**请求示例**：

```json
{
  "script_id": 123,
  "tone": "专业",
  "length_type": "详细版"
}
```

**响应示例**：

```json
{
  "original_content": "您好，关于[需求名称]，我想确认一下...",
  "adjusted_content": "您好，关于[需求名称]，我想确认一下...\n\n补充说明：如果您需要更详细的沟通方案，可以根据具体情况调整话术的细节部分，确保沟通效果最佳。",
  "tone": "专业",
  "length_type": "详细版"
}
```

**错误码**：
- 404：话术不存在

---

### 3.3 获取对话历史

**接口地址**：`GET /api/chat/history/{session_id}`

**请求头**：
```
Authorization: Bearer <token>
```

**路径参数**：

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| session_id | string | 是 | 会话ID |

**响应示例**：

```json
[
  {
    "id": 1,
    "message_type": "user",
    "content": "我需要向产品经理反馈一个需求不合理的问题",
    "intent": null,
    "referenced_script_id": null,
    "created_at": "2026-02-18T10:00:00"
  },
  {
    "id": 2,
    "message_type": "assistant",
    "content": "为您找到了3条需求沟通相关的话术...",
    "intent": "search",
    "referenced_script_id": null,
    "created_at": "2026-02-18T10:00:01"
  }
]
```

**错误码**：
- 401：未认证或令牌无效

---

## 4. 话术接口

### 4.1 获取话术列表

**接口地址**：`GET /api/scripts/`

**请求参数**（Query参数）：

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| position_id | integer | 否 | 岗位ID |
| category_id | integer | 否 | 分类ID |
| scene_type | string | 否 | 场景类型 |
| tone | string | 否 | 语气 |
| keyword | string | 否 | 关键词 |
| page | integer | 否 | 页码，默认1 |
| page_size | integer | 否 | 每页数量，默认10，最大50 |

**请求示例**：

```
GET /api/scripts/?position_id=3&scene_type=需求沟通&tone=温和&page=1&page_size=10
```

**响应示例**：

```json
{
  "scripts": [
    {
      "id": 123,
      "title": "需求确认话术",
      "content": "您好，关于[需求名称]，我想确认一下...",
      "brief_content": "关于[需求]需要确认...",
      "category_id": 12,
      "position_id": 3,
      "scene_type": "需求沟通",
      "tone": "温和",
      "target_audience": "同事",
      "tags": "需求确认,需求沟通",
      "usage_count": 45,
      "like_count": 12,
      "is_free": true,
      "created_at": "2026-02-18T10:00:00"
    }
  ],
  "total": 45,
  "page": 1,
  "page_size": 10,
  "total_pages": 5
}
```

---

### 4.2 获取话术详情

**接口地址**：`GET /api/scripts/{script_id}`

**请求头**：
```
Authorization: Bearer <token>
```

**路径参数**：

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| script_id | integer | 是 | 话术ID |

**响应示例**：

```json
{
  "id": 123,
  "title": "需求确认话术",
  "content": "您好，关于[需求名称]，我想确认一下：[具体问题]。这样可以避免后续返工，谢谢！",
  "brief_content": "关于[需求]需要确认：[问题]，避免返工。",
  "category_id": 12,
  "position_id": 3,
  "scene_type": "需求沟通",
  "tone": "温和",
  "target_audience": "同事",
  "tags": "需求确认,需求沟通",
  "usage_count": 46,
  "like_count": 12,
  "is_free": true,
  "created_at": "2026-02-18T10:00:00",
  "category": {
    "id": 12,
    "name": "需求传递",
    "code": "pm_transfer",
    "parent_id": 11,
    "position_id": 3,
    "description": "需求传递话术",
    "sort_order": 12
  },
  "is_favorite": false
}
```

**错误码**：
- 401：未认证或令牌无效
- 404：话术不存在

---

### 4.3 点赞话术

**接口地址**：`POST /api/scripts/{script_id}/like`

**路径参数**：

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| script_id | integer | 是 | 话术ID |

**响应示例**：

```json
{
  "message": "点赞成功",
  "like_count": 13
}
```

**错误码**：
- 404：话术不存在

---

### 4.4 添加收藏

**接口地址**：`POST /api/scripts/favorites`

**请求头**：
```
Authorization: Bearer <token>
```

**请求参数**：

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| script_id | integer | 是 | 话术ID |
| custom_content | string | 否 | 自定义内容 |

**请求示例**：

```json
{
  "script_id": 123,
  "custom_content": "修改后的内容..."
}
```

**响应示例**：

```json
{
  "id": 1,
  "user_id": 1,
  "script_id": 123,
  "custom_content": "修改后的内容...",
  "created_at": "2026-02-18T10:00:00"
}
```

**错误码**：
- 401：未认证或令牌无效
- 400：话术不存在、已经收藏过该话术

---

### 4.5 取消收藏

**接口地址**：`DELETE /api/scripts/favorites/{script_id}`

**请求头**：
```
Authorization: Bearer <token>
```

**路径参数**：

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| script_id | integer | 是 | 话术ID |

**响应**：204 No Content

**错误码**：
- 401：未认证或令牌无效
- 404：收藏不存在

---

### 4.6 获取收藏列表

**接口地址**：`GET /api/scripts/favorites/list`

**请求头**：
```
Authorization: Bearer <token>
```

**响应示例**：

```json
[
  {
    "id": 1,
    "user_id": 1,
    "script_id": 123,
    "custom_content": "修改后的内容...",
    "script": {
      "id": 123,
      "title": "需求确认话术",
      "content": "您好，关于[需求名称]，我想确认一下...",
      "brief_content": "关于[需求]需要确认...",
      "category_id": 12,
      "position_id": 3,
      "scene_type": "需求沟通",
      "tone": "温和",
      "target_audience": "同事",
      "tags": "需求确认,需求沟通",
      "usage_count": 45,
      "like_count": 12,
      "is_free": true,
      "created_at": "2026-02-18T10:00:00"
    },
    "created_at": "2026-02-18T10:00:00"
  }
]
```

**错误码**：
- 401：未认证或令牌无效

---

## 5. 系统接口

### 5.1 系统健康检查

**接口地址**：`GET /`

**响应示例**：

```json
{
  "message": "VibeCoding高情商聊天助手 API",
  "version": "1.0.0",
  "docs": "/docs"
}
```

### 5.2 系统配置

**接口地址**：`GET /api/system/config`

**响应示例**：

```json
{
  "app_name": "VibeCoding高情商聊天助手",
  "version": "1.0.0",
  "default_tone": "温和",
  "default_length": "简洁版",
  "max_context_turns": 10,
  "response_timeout": 2
}
```

---

## 6. 错误码说明

### 6.1 通用错误码

| 错误码 | 说明 |
|--------|------|
| 400 | 请求参数错误 |
| 401 | 未认证或令牌无效 |
| 404 | 资源不存在 |
| 500 | 服务器内部错误 |

### 6.2 认证错误码

| 错误码 | 说明 |
|--------|------|
| AUTH_001 | 用户名或密码错误 |
| AUTH_002 | 用户已被禁用 |
| AUTH_003 | 令牌无效或已过期 |
| AUTH_004 | 令牌格式错误 |

### 6.3 业务错误码

| 错误码 | 说明 |
|--------|------|
| BIZ_001 | 用户名已存在 |
| BIZ_002 | 手机号已被注册 |
| BIZ_003 | 话术不存在 |
| BIZ_004 | 已经收藏过该话术 |
| BIZ_005 | 收藏不存在 |

---

## 7. 接口示例

### 7.1 完整对话流程

```javascript
// 1. 用户登录
const loginResponse = await fetch('http://localhost:8000/api/auth/login', {
  method: 'POST',
  headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
  body: 'username=testuser&password=password123'
});
const { access_token } = await loginResponse.json();

// 2. 发送消息
const chatResponse = await fetch('http://localhost:8000/api/chat/message', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${access_token}`
  },
  body: JSON.stringify({
    message: '我需要向产品经理反馈一个需求不合理的问题'
  })
});
const chatData = await chatResponse.json();

// 3. 获取话术详情
const scriptId = chatData.scripts[0].id;
const scriptResponse = await fetch(`http://localhost:8000/api/scripts/${scriptId}`, {
  headers: { 'Authorization': `Bearer ${access_token}` }
});
const scriptData = await scriptResponse.json();

// 4. 添加收藏
await fetch('http://localhost:8000/api/scripts/favorites', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${access_token}`
  },
  body: JSON.stringify({ script_id: scriptId })
});
```

### 7.2 搜索话术流程

```javascript
const searchResponse = await fetch('http://localhost:8000/api/scripts/?keyword=需求确认&position_id=3&page=1&page_size=10');
const searchData = await searchResponse.json();
console.log(`找到 ${searchData.total} 条话术`);
```

---

## 8. 接口测试

### 8.1 Swagger UI

后端启动后，访问 `http://localhost:8000/docs` 查看交互式API文档，支持在线测试所有接口。

### 8.2 使用curl测试

```bash
# 登录
curl -X POST "http://localhost:8000/api/auth/login" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "username=testuser&password=password123"

# 获取话术列表
curl -X GET "http://localhost:8000/api/scripts/?position_id=3" \
  -H "Authorization: Bearer YOUR_TOKEN"

# 发送消息
curl -X POST "http://localhost:8000/api/chat/message" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{"message": "我需要需求沟通的话术"}'
```

---

## 9. 版本说明

### 当前版本：V1.0

### 版本历史

| 版本 | 日期 | 说明 |
|------|------|------|
| V1.0 | 2026-02-18 | 初始版本，包含所有核心功能 |

---

**文档结束**
