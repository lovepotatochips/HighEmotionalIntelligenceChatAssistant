# 高情商聊天助手 - API接口说明文档

## 接口概述

### 基本信息
- **基础URL**：`http://localhost:8000/api`
- **数据格式**：JSON
- **字符编码**：UTF-8
- **认证方式**：JWT Token

### 认证机制
除登录和注册接口外，所有接口都需要在请求头中携带JWT Token：

```http
Authorization: Bearer <token>
```

### 响应格式
成功响应：
```json
{
  "data": {},
  "message": "success"
}
```

错误响应：
```json
{
  "detail": "错误描述"
}
```

### 状态码说明
- `200 OK`：请求成功
- `201 Created`：创建成功
- `400 Bad Request`：请求参数错误
- `401 Unauthorized`：未认证或认证失败
- `403 Forbidden`：无权限访问
- `404 Not Found`：资源不存在
- `500 Internal Server Error`：服务器内部错误

## 1. 认证模块

### 1.1 用户注册

**接口地址**：`POST /auth/register`

**请求参数**：
```json
{
  "username": "string",      // 用户名，3-50字符，必填
  "password": "string",      // 密码，必填
  "phone": "string",         // 手机号，可选
  "email": "string",         // 邮箱，可选
  "role": "string",          // 岗位，必填
  "avatar_url": "string",     // 头像URL，可选
  "tone_preference": "string", // 语气偏好，可选，默认"温和"
  "length_preference": "string" // 长度偏好，可选，默认"简洁版"
}
```

**响应示例**：
```json
{
  "id": 1,
  "username": "testuser",
  "phone": null,
  "email": null,
  "role": "user",
  "avatar_url": null,
  "tone_preference": "温和",
  "length_preference": "简洁版",
  "is_active": true,
  "is_vip": false,
  "vip_expire_time": null,
  "created_at": "2024-02-16T10:00:00.000000"
}
```

**错误响应**：
```json
{
  "detail": "用户名已存在"
}
```

### 1.2 用户登录

**接口地址**：`POST /auth/login`

**请求参数**（Form Data）：
```
username: string  // 用户名，必填
password: string  // 密码，必填
```

**响应示例**：
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "bearer",
  "user": {
    "id": 1,
    "username": "testuser",
    "phone": null,
    "email": null,
    "role": "user",
    "avatar_url": null,
    "tone_preference": "温和",
    "length_preference": "简洁版",
    "is_active": true,
    "is_vip": false,
    "vip_expire_time": null,
    "created_at": "2024-02-16T10:00:00.000000"
  }
}
```

**错误响应**：
```json
{
  "detail": "用户名或密码错误"
}
```

### 1.3 获取当前用户信息

**接口地址**：`GET /auth/me`

**请求头**：
```http
Authorization: Bearer <token>
```

**响应示例**：
```json
{
  "id": 1,
  "username": "testuser",
  "phone": null,
  "email": null,
  "role": "user",
  "avatar_url": null,
  "tone_preference": "温和",
  "length_preference": "简洁版",
  "is_active": true,
  "is_vip": false,
  "vip_expire_time": null,
  "created_at": "2024-02-16T10:00:00.000000"
}
```

### 1.4 更新用户信息

**接口地址**：`PUT /auth/me`

**请求头**：
```http
Authorization: Bearer <token>
```

**请求参数**：
```json
{
  "phone": "string",         // 手机号，可选
  "email": "string",         // 邮箱，可选
  "role": "string",          // 岗位，可选
  "avatar_url": "string",     // 头像URL，可选
  "tone_preference": "string", // 语气偏好，可选
  "length_preference": "string" // 长度偏好，可选
}
```

**响应示例**：
```json
{
  "id": 1,
  "username": "testuser",
  "phone": "13800138000",
  "email": "test@example.com",
  "role": "product_manager",
  "avatar_url": "https://example.com/avatar.jpg",
  "tone_preference": "专业",
  "length_preference": "标准版",
  "is_active": true,
  "is_vip": false,
  "vip_expire_time": null,
  "created_at": "2024-02-16T10:00:00.000000"
}
```

## 2. 对话模块

### 2.1 发送消息

**接口地址**：`POST /chat/send`

**请求头**：
```http
Authorization: Bearer <token>
```

**请求参数**：
```json
{
  "message": "string",          // 用户消息，必填
  "session_id": "string",       // 会话ID，可选
  "position": "string",         // 岗位，可选
  "tone": "string",             // 语气，可选
  "length": "string"            // 长度，可选
}
```

**响应示例**：
```json
{
  "reply": "根据您的需求，我建议您可以这样表达：...",
  "scripts": [
    {
      "id": 1,
      "title": "需求反馈话术",
      "content": "您好，关于这个需求...",
      "brief_content": "您好，关于...",
      "category_id": 12,
      "position_id": 3,
      "scene_type": "需求对接",
      "tone": "温和",
      "target_audience": "同事",
      "tags": "需求,反馈",
      "usage_count": 10,
      "like_count": 5,
      "is_free": true,
      "created_at": "2024-02-16T10:00:00.000000"
    }
  ],
  "session_id": "session_123456",
  "intent": "需求反馈"
}
```

### 2.2 获取对话历史

**接口地址**：`GET /chat/history`

**请求头**：
```http
Authorization: Bearer <token>
```

**请求参数**：
- `session_id`：会话ID，可选
- `limit`：返回数量，可选，默认20

**响应示例**：
```json
[
  {
    "id": 1,
    "user_id": 1,
    "session_id": "session_123456",
    "message_type": "user",
    "content": "我需要向产品经理反馈需求问题",
    "context_data": {},
    "intent": "需求反馈",
    "referenced_script_id": null,
    "created_at": "2024-02-16T10:00:00.000000"
  },
  {
    "id": 2,
    "user_id": 1,
    "session_id": "session_123456",
    "message_type": "assistant",
    "content": "根据您的需求，我建议...",
    "context_data": {},
    "intent": "需求反馈",
    "referenced_script_id": 1,
    "created_at": "2024-02-16T10:00:05.000000"
  }
]
```

## 3. 话术模块

### 3.1 获取岗位列表

**接口地址**：`GET /scripts/positions`

**响应示例**：
```json
[
  {
    "id": 1,
    "name": "售前人员",
    "code": "pre_sales",
    "description": "负责客户对接、需求咨询、方案讲解",
    "sort_order": 1
  },
  {
    "id": 2,
    "name": "项目经理",
    "code": "project_manager",
    "description": "负责项目统筹、进度管理、团队协调",
    "sort_order": 2
  }
]
```

### 3.2 获取分类列表

**接口地址**：`GET /scripts/categories`

**请求参数**：
- `position_id`：岗位ID，可选

**响应示例**：
```json
[
  {
    "id": 1,
    "name": "客户对接",
    "code": "pre_sales_customer",
    "parent_id": 0,
    "position_id": 1,
    "description": "售前人员客户对接相关话术",
    "icon": "customer",
    "sort_order": 1
  },
  {
    "id": 2,
    "name": "需求咨询",
    "code": "pre_sales_consultation",
    "parent_id": 1,
    "position_id": 1,
    "description": "需求咨询话术",
    "icon": "consultation",
    "sort_order": 2
  }
]
```

### 3.3 获取话术列表

**接口地址**：`GET /scripts`

**请求参数**：
- `position_id`：岗位ID，可选
- `category_id`：分类ID，可选
- `tone`：语气，可选
- `scene_type`：场景类型，可选
- `page`：页码，可选，默认1
- `page_size`：每页数量，可选，默认10

**响应示例**：
```json
{
  "scripts": [
    {
      "id": 1,
      "title": "客户需求初步了解",
      "content": "您好！非常感谢您对我们产品的关注...",
      "brief_content": "您好！感谢关注...",
      "category_id": 2,
      "position_id": 1,
      "scene_type": "需求对接",
      "tone": "温和",
      "target_audience": "客户",
      "tags": "需求咨询,初步沟通",
      "usage_count": 10,
      "like_count": 5,
      "is_free": true,
      "created_at": "2024-02-16T10:00:00.000000"
    }
  ],
  "total": 100,
  "page": 1,
  "page_size": 10,
  "total_pages": 10
}
```

### 3.4 获取话术详情

**接口地址**：`GET /scripts/{id}`

**请求头**：
```http
Authorization: Bearer <token>
```

**响应示例**：
```json
{
  "id": 1,
  "title": "客户需求初步了解",
  "content": "您好！非常感谢您对我们产品的关注。为了更好地为您提供服务，想先了解一下您的具体需求和期望，方便吗？",
  "brief_content": "您好！感谢关注，想了解一下您的具体需求。",
  "category": {
    "id": 2,
    "name": "需求咨询",
    "code": "pre_sales_consultation",
    "parent_id": 1,
    "position_id": 1,
    "description": "需求咨询话术"
  },
  "position": {
    "id": 1,
    "name": "售前人员",
    "code": "pre_sales",
    "description": "负责客户对接、需求咨询、方案讲解"
  },
  "scene_type": "需求对接",
  "tone": "温和",
  "target_audience": "客户",
  "tags": "需求咨询,初步沟通",
  "usage_count": 10,
  "like_count": 5,
  "is_free": true,
  "is_favorite": false,
  "created_at": "2024-02-16T10:00:00.000000"
}
```

### 3.5 搜索话术

**接口地址**：`GET /scripts/search`

**请求参数**：
- `keyword`：关键词，必填
- `position_id`：岗位ID，可选
- `category_id`：分类ID，可选
- `tone`：语气，可选
- `scene_type`：场景类型，可选
- `page`：页码，可选，默认1
- `page_size`：每页数量，可选，默认10

**响应示例**：
```json
{
  "scripts": [
    {
      "id": 1,
      "title": "客户需求初步了解",
      "content": "您好！非常感谢您对我们产品的关注...",
      "brief_content": "您好！感谢关注...",
      "category_id": 2,
      "position_id": 1,
      "scene_type": "需求对接",
      "tone": "温和",
      "target_audience": "客户",
      "tags": "需求咨询,初步沟通",
      "usage_count": 10,
      "like_count": 5,
      "is_free": true,
      "created_at": "2024-02-16T10:00:00.000000"
    }
  ],
  "total": 10,
  "page": 1,
  "page_size": 10,
  "total_pages": 1
}
```

### 3.6 调整话术

**接口地址**：`POST /scripts/adjust`

**请求头**：
```http
Authorization: Bearer <token>
```

**请求参数**：
```json
{
  "script_id": 1,              // 话术ID，必填
  "tone": "专业",              // 语气，可选
  "length_type": "详细版"      // 长度类型，可选
}
```

**响应示例**：
```json
{
  "original_content": "您好！感谢关注，想了解一下您的具体需求。",
  "adjusted_content": "您好！非常感谢您对我们产品的关注。为了能够更好地为您提供服务，我希望能够详细了解您的具体需求和期望，不知您是否方便告知？这样我们可以为您制定更合适的解决方案。",
  "tone": "专业",
  "length_type": "详细版"
}
```

## 4. 收藏模块

### 4.1 添加收藏

**接口地址**：`POST /favorites`

**请求头**：
```http
Authorization: Bearer <token>
```

**请求参数**：
```json
{
  "script_id": 1,              // 话术ID，必填
  "custom_content": "string"     // 自定义内容，可选
}
```

**响应示例**：
```json
{
  "id": 1,
  "user_id": 1,
  "script_id": 1,
  "custom_content": "这是我的自定义备注",
  "created_at": "2024-02-16T10:00:00.000000"
}
```

### 4.2 获取收藏列表

**接口地址**：`GET /favorites`

**请求头**：
```http
Authorization: Bearer <token>
```

**响应示例**：
```json
[
  {
    "id": 1,
    "user_id": 1,
    "script_id": 1,
    "custom_content": "这是我的自定义备注",
    "script": {
      "id": 1,
      "title": "客户需求初步了解",
      "content": "您好！非常感谢您对我们产品的关注...",
      "brief_content": "您好！感谢关注...",
      "category_id": 2,
      "position_id": 1,
      "scene_type": "需求对接",
      "tone": "温和",
      "target_audience": "客户",
      "tags": "需求咨询,初步沟通",
      "usage_count": 10,
      "like_count": 5,
      "is_free": true,
      "created_at": "2024-02-16T10:00:00.000000"
    },
    "created_at": "2024-02-16T10:00:00.000000"
  }
]
```

### 4.3 删除收藏

**接口地址**：`DELETE /favorites/{script_id}`

**请求头**：
```http
Authorization: Bearer <token>
```

**响应示例**：
```json
{
  "message": "删除成功"
}
```

## 5. 系统模块

### 5.1 健康检查

**接口地址**：`GET /health`

**响应示例**：
```json
{
  "status": "ok",
  "app_name": "高情商聊天助手",
  "version": "1.0.0",
  "timestamp": "2024-02-16T10:00:00.000000"
}
```

### 5.2 获取系统配置

**接口地址**：`GET /system/config`

**响应示例**：
```json
{
  "app_name": "高情商聊天助手",
  "default_tone": "温和",
  "default_length": "简洁版",
  "max_context_turns": 10,
  "response_timeout": 2
}
```

## 错误码说明

### 通用错误码

| 错误码 | 说明 | 解决方案 |
|--------|------|----------|
| 400 | 请求参数错误 | 检查请求参数格式和内容 |
| 401 | 未认证或认证失败 | 检查Token是否有效 |
| 403 | 无权限访问 | 检查用户权限 |
| 404 | 资源不存在 | 检查请求的资源ID |
| 500 | 服务器内部错误 | 联系技术支持 |

### 业务错误码

| 错误信息 | 说明 | 解决方案 |
|----------|------|----------|
| 用户名已存在 | 注册时用户名重复 | 更换用户名 |
| 手机号已被注册 | 注册时手机号重复 | 更换手机号或联系客服 |
| 用户名或密码错误 | 登录凭证错误 | 检查用户名和密码 |
| 用户已被禁用 | 账号被禁用 | 联系管理员 |
| 话术不存在 | 指定的话术不存在 | 检查话术ID |

## 接口调用示例

### JavaScript/TypeScript

```javascript
import axios from 'axios'

const API_BASE = 'http://localhost:8000/api'

// 设置请求拦截器
axios.interceptors.request.use(config => {
  const token = localStorage.getItem('token')
  if (token) {
    config.headers.Authorization = `Bearer ${token}`
  }
  return config
})

// 登录
async function login(username, password) {
  const formData = new FormData()
  formData.append('username', username)
  formData.append('password', password)
  
  const response = await axios.post(`${API_BASE}/auth/login`, formData)
  localStorage.setItem('token', response.data.access_token)
  return response.data
}

// 获取话术列表
async function getScripts(params) {
  const token = localStorage.getItem('token')
  const response = await axios.get(`${API_BASE}/scripts`, {
    headers: { Authorization: `Bearer ${token}` },
    params
  })
  return response.data
}

// 发送消息
async function sendMessage(message) {
  const token = localStorage.getItem('token')
  const response = await axios.post(`${API_BASE}/chat/send`, {
    message
  }, {
    headers: { Authorization: `Bearer ${token}` }
  })
  return response.data
}
```

### cURL

```bash
# 登录
curl -X POST http://localhost:8000/api/auth/login \
  -F "username=testuser" \
  -F "password=123"

# 获取话术列表
curl -X GET "http://localhost:8000/api/scripts?page=1&page_size=10" \
  -H "Authorization: Bearer YOUR_TOKEN"

# 发送消息
curl -X POST http://localhost:8000/api/chat/send \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"message":"我需要向产品经理反馈需求问题"}'

# 添加收藏
curl -X POST http://localhost:8000/api/favorites \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"script_id":1}'
```

### Python

```python
import requests

API_BASE = 'http://localhost:8000/api'

class ChatAssistantAPI:
    def __init__(self):
        self.token = None
        self.session = requests.Session()
    
    def login(self, username, password):
        data = {
            'username': username,
            'password': password
        }
        response = self.session.post(f'{API_BASE}/auth/login', data=data)
        response.raise_for_status()
        self.token = response.json()['access_token']
        return response.json()
    
    def get_headers(self):
        headers = {}
        if self.token:
            headers['Authorization'] = f'Bearer {self.token}'
        return headers
    
    def get_scripts(self, **params):
        response = self.session.get(
            f'{API_BASE}/scripts',
            headers=self.get_headers(),
            params=params
        )
        response.raise_for_status()
        return response.json()
    
    def send_message(self, message):
        data = {'message': message}
        response = self.session.post(
            f'{API_BASE}/chat/send',
            headers=self.get_headers(),
            json=data
        )
        response.raise_for_status()
        return response.json()

# 使用示例
api = ChatAssistantAPI()
api.login('testuser', '123')
scripts = api.get_scripts(page=1, page_size=10)
reply = api.send_message('我需要向产品经理反馈需求问题')
```

## 接口限制

### 速率限制
- 普通用户：每分钟最多60次请求
- VIP用户：每分钟最多120次请求

### 文件大小限制
- 头像上传：最大5MB
- 图片上传：最大10MB

### 数据查询限制
- 单次查询最多返回100条记录
- 分页查询每页最多50条记录

## 接口版本控制

当前版本：v1.0

未来版本将遵循语义化版本控制，并在URL中包含版本号：
- v1.0：`http://localhost:8000/api/v1/...`
- v2.0：`http://localhost:8000/api/v2/...`

## 开发环境

### Swagger文档
访问 `http://localhost:8000/docs` 查看完整的API文档和在线测试。

### 测试环境
- 测试用户：`testuser`
- 测试密码：`123`

## 联系方式

如有接口使用问题，请联系：
- 技术支持：tech@example.com
- 文档反馈：docs@example.com
